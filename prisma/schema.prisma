generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model AuditLog {
  id        String   @id
  userId    String?
  action    String
  entity    String
  entityId  String
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  User      User?    @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([createdAt])
  @@index([entity, entityId])
  @@index([userId])
}

model EmailLog {
  id        String    @id
  to        String
  subject   String
  status    String
  provider  String
  messageId String?
  error     String?
  sentAt    DateTime?
  failedAt  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime

  @@index([createdAt])
  @@index([status])
  @@index([to])
}

model Entitlement {
  id           String    @id
  userId       String
  productId    String
  orderId      String?
  active       Boolean   @default(true)
  expiresAt    DateTime?
  revokedAt    DateTime?
  revokeReason String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
  Order        Order?    @relation(fields: [orderId], references: [id])
  Product      Product   @relation(fields: [productId], references: [id])
  User         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([active])
  @@index([orderId])
  @@index([productId])
  @@index([userId])
}

model IdempotencyKey {
  id        String   @id
  key       String   @unique
  operation String
  result    Json?
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([expiresAt])
  @@index([key])
}

model MediaAsset {
  id        String   @id
  key       String   @unique
  url       String
  size      Int
  mimeType  String
  alt       String?
  checksum  String?
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime
  User      User     @relation(fields: [createdBy], references: [id])

  @@index([createdBy])
  @@index([key])
}

model Order {
  id                    String        @id
  userId                String?
  total                 Int
  currency              String        @default("USD")
  stripeSessionId       String?       @unique
  stripePaymentIntentId String?       @unique
  customerEmail         String
  customerName          String?
  fulfilledAt           DateTime?
  refundedAt            DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime
  status                OrderStatus   @default(pending)
  Entitlement           Entitlement[]
  User                  User?         @relation(fields: [userId], references: [id])
  OrderItem             OrderItem[]

  @@index([createdAt])
  @@index([customerEmail])
  @@index([status])
  @@index([stripeSessionId])
  @@index([userId])
}

model OrderItem {
  id          String   @id
  orderId     String
  productId   String
  amount      Int
  currency    String
  productName String
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  Order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  Product     Product  @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
}

model Page {
  id              String   @id
  title           String
  slug            String   @unique
  content         String
  template        String?
  status          String   @default("draft")
  metaTitle       String?
  metaDescription String?
  ogImage         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime

  @@index([slug])
  @@index([status])
}

model Post {
  id                  String    @id
  title               String
  slug                String    @unique
  content             String
  excerpt             String?
  publishedAt         DateTime?
  status              String    @default("draft")
  authorId            String
  metaTitle           String?
  metaDescription     String?
  ogImage             String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime
  contextLine         String?
  description         String
  diagramUrl          String?
  featured            Boolean   @default(false)
  published           Boolean   @default(false)
  readingTime         Int?
  relatedProjectSlugs String[]
  relatedStartupSlugs String[]
  theme               String?
  User                User      @relation(fields: [authorId], references: [id])
  TagLink             TagLink[]

  @@index([authorId])
  @@index([featured])
  @@index([publishedAt])
  @@index([published])
  @@index([slug])
  @@index([status])
  @@index([theme])
}

model Product {
  id                  String        @id
  slug                String        @unique
  description         String
  createdAt           DateTime      @default(now())
  updatedAt           DateTime
  currency            String        @default("AUD")
  downloadUrls        String[]
  featured            Boolean       @default(false)
  format              String
  howItWasCreated     String
  nonAudience         String
  pageCount           Int?
  priceInCents        Int
  published           Boolean       @default(false)
  relatedPostSlugs    String[]
  relatedProjectSlugs String[]
  stripePriceId       String?
  stripeProductId     String?       @unique
  targetAudience      String
  title               String
  whatItCovers        String
  whatItIs            String
  whatYouGet          String
  metaDescription     String?
  metaTitle           String?
  ogImage             String?

  // NEW: Search and tagging support
  searchVector        String?
  tags                String[]      @default([])

  // Relations
  Entitlement         Entitlement[]
  OrderItem           OrderItem[]
  categories          ProductCategory[]

  @@index([published])
  @@index([slug])
  @@index([tags])
}

model ResourceCategory {
  id              String   @id @default(cuid())
  name            String
  slug            String
  description     String?
  parentId        String?
  path            String
  level           Int
  displayOrder    Int      @default(0)
  published       Boolean  @default(true)

  // SEO
  metaTitle       String?
  metaDescription String?

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  parent          ResourceCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children        ResourceCategory[] @relation("CategoryHierarchy")
  products        ProductCategory[]

  @@unique([slug, parentId])
  @@unique([path])
  @@index([parentId])
  @@index([path])
  @@index([level])
  @@index([displayOrder])
  @@index([published])
}

model ProductCategory {
  id           String   @id @default(cuid())
  productId    String
  categoryId   String
  isPrimary    Boolean  @default(false)
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now())

  product      Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  category     ResourceCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([productId, categoryId])
  @@index([productId])
  @@index([categoryId])
  @@index([isPrimary])
}

model Project {
  id                  String    @id
  title               String
  slug                String    @unique
  description         String
  featured            Boolean   @default(false)
  authorId            String
  metaTitle           String?
  metaDescription     String?
  ogImage             String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime
  diagrams            String[]
  displayOrder        Int       @default(0)
  execution           String
  outcome             String
  outcomeDetail       String
  overview            String
  projectStatus       String
  published           Boolean   @default(false)
  reflection          String?
  relatedPostSlugs    String[]
  relatedStartupSlugs String[]
  role                String
  roleDetail          String
  screenshots         String[]
  teamSize            Int?
  User                User      @relation(fields: [authorId], references: [id])
  TagLink             TagLink[]

  @@index([authorId])
  @@index([displayOrder])
  @@index([featured])
  @@index([published])
  @@index([slug])
}

model Role {
  id          String     @id
  name        String     @unique
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime
  UserRole    UserRole[]
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Startup {
  id                  String    @id
  slug                String    @unique
  description         String
  status              String
  authorId            String
  metaTitle           String?
  metaDescription     String?
  ogImage             String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime
  diagrams            String[]
  displayOrder        Int       @default(0)
  featured            Boolean   @default(false)
  learnings           String
  metrics             Json?
  name                String
  outcomes            String
  overview            String
  published           Boolean   @default(false)
  relatedPostSlugs    String[]
  relatedProjectSlugs String[]
  role                String
  roleDetail          String
  screenshots         String[]
  statusDetail        String
  systemsBuilt        String
  whyItExists         String
  User                User      @relation(fields: [authorId], references: [id])
  TagLink             TagLink[]

  @@index([authorId])
  @@index([displayOrder])
  @@index([featured])
  @@index([published])
  @@index([slug])
}

model StripeEvent {
  id              String    @id
  eventId         String    @unique
  type            String
  processed       Boolean   @default(false)
  processingError String?
  data            Json
  createdAt       DateTime  @default(now())
  processedAt     DateTime?

  @@index([eventId])
  @@index([processed])
  @@index([type])
}

model Tag {
  id        String    @id
  name      String    @unique
  slug      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime
  TagLink   TagLink[]

  @@index([slug])
}

model TagLink {
  id        String   @id
  tagId     String
  postId    String?
  projectId String?
  startupId String?
  Post      Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  Project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  Startup   Startup? @relation(fields: [startupId], references: [id], onDelete: Cascade)
  Tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([tagId, postId])
  @@unique([tagId, projectId])
  @@unique([tagId, startupId])
  @@index([postId])
  @@index([projectId])
  @@index([startupId])
  @@index([tagId])
}

model User {
  id                 String              @id @default(cuid())
  email              String              @unique
  name               String?
  password           String?             // Hashed with bcrypt
  image              String?
  stripeCustomerId   String?             @unique
  emailVerified      DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  Account            Account[]
  AuditLog           AuditLog[]
  Entitlement        Entitlement[]
  MediaAsset         MediaAsset[]
  Order              Order[]
  PasswordResetToken PasswordResetToken[]
  Post               Post[]
  Project            Project[]
  Session            Session[]
  Startup            Startup[]
  TutoringSession    TutoringSession[]
  TutoringBooking    TutoringBooking[]
  UserRole           UserRole[]

  @@index([email])
  @@index([stripeCustomerId])
}

model UserRole {
  id        String   @id
  userId    String
  roleId    String
  createdAt DateTime @default(now())
  Role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([roleId])
  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expires   DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model FailedJob {
  id          String          @id
  jobType     String
  payload     Json
  error       String
  attempts    Int             @default(0)
  maxAttempts Int             @default(3)
  status      FailedJobStatus @default(PENDING)
  createdAt   DateTime        @default(now())
  retriedAt   DateTime?
  resolvedAt  DateTime?

  @@index([status])
  @@index([jobType])
  @@index([createdAt])
}

enum FailedJobStatus {
  PENDING
  RETRYING
  RESOLVED
  ABANDONED
}

enum OrderStatus {
  pending
  processing
  completed
  failed
  refunded
}

model AnalyticsEvent {
  id         String   @id @default(cuid())
  eventName  String   // e.g., "resource_viewed", "markpoint_clicked", "extension_1_downloaded"
  path       String?  // URL path where event occurred
  userId     String?  // Optional - only if user is logged in
  metadata   Json?    // Additional data (resource slug, product id, etc.)
  createdAt  DateTime @default(now())

  @@index([eventName])
  @@index([createdAt])
  @@index([userId])
}

// ─── Tutoring System ──────────────────────────────────────────────────────────

model TutoringPackage {
  id                     String   @id @default(cuid())
  name                   String   // "Trial Session", "Single Session", "5-Session Block"
  slug                   String   @unique
  description            String
  sessionCount           Int      // number of sessions included
  durationMinutes        Int      // per-session duration
  priceInCents           Int      // AUD cents
  currency               String   @default("AUD")
  published              Boolean  @default(false)
  featured               Boolean  @default(false)
  displayOrder           Int      @default(0)
  calendlyEventTypeSlug  String?  // matches the Calendly Event Type slug

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  sessions   TutoringSession[]
  inquiries  TutoringInquiry[]

  @@index([published])
  @@index([displayOrder])
}

model TutoringSession {
  id                  String                @id @default(cuid())
  packageId           String?
  userId              String?               // linked if student has a Riqle account

  // Calendly identifiers
  calendlyEventId     String                @unique  // Calendly invitee UUID (idempotency key)
  calendlyEventUri    String?
  calendlyInviteeUri  String?

  // Session details
  status              TutoringSessionStatus @default(scheduled)
  scheduledAt         DateTime
  durationMinutes     Int
  meetingUrl          String?               // Zoom/Meet link from Calendly

  // Student info (denormalised — Calendly provides this, may be a guest)
  studentName         String
  studentEmail        String
  studentPhone        String?

  // Academic context (collected via Calendly question form)
  yearLevel           String?               // "Year 12", "Year 11"
  subject             String?               // "HSC English Advanced", "Extension 1"
  goals               String?               // what the student wants from sessions

  // Internal
  tutorNotes          String?
  sessionSummary      String?

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  cancelledAt  DateTime?
  completedAt  DateTime?

  Package  TutoringPackage? @relation(fields: [packageId], references: [id])
  User     User?            @relation(fields: [userId], references: [id])

  @@index([status])
  @@index([scheduledAt])
  @@index([studentEmail])
  @@index([userId])
  @@index([packageId])
}

model TutoringInquiry {
  id        String                 @id @default(cuid())
  packageId String?
  name      String
  email     String
  phone     String?
  message   String
  yearLevel String?
  subject   String?
  status    TutoringInquiryStatus  @default(new)

  respondedAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  Package  TutoringPackage? @relation(fields: [packageId], references: [id])

  @@index([status])
  @@index([createdAt])
  @@index([email])
}

enum TutoringSessionStatus {
  scheduled
  completed
  cancelled
  no_show
  rescheduled
}

enum TutoringInquiryStatus {
  new
  contacted
  booked
  closed
}

// ─── Scheduling System ─────────────────────────────────────────────────────────

model AvailabilityRule {
  id        String  @id @default(cuid())
  dayOfWeek Int     // 0=Sun 1=Mon … 6=Sat
  startTime String  // "16:00" 24hr AEST
  endTime   String  // "20:00"
  active    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dayOfWeek])
  @@index([active])
}

model AvailabilityBlock {
  id     String    @id @default(cuid())
  date   DateTime  // midnight UTC of the blocked AEST date
  reason String?   // internal note (exam period, holiday, etc.)

  createdAt DateTime @default(now())

  @@index([date])
}

model TutoringBooking {
  id              String                @id @default(cuid())
  studentName     String
  studentEmail    String
  studentPhone    String?
  yearLevel       String?               // "Year 12", "Year 11"
  subject         String?               // "English Advanced", "Extension 1"
  goals           String?
  scheduledAt     DateTime              // UTC; display in AEST
  durationMinutes Int                   @default(60)
  meetingFormat       MeetingFormat
  preferredLocation   String?               // in-person preferred suburb/area (admin reviews)
  status              TutoringBookingStatus @default(pending)
  meetingLink         String?               // Zoom URL set by admin on confirmation
  adminNotes          String?
  userId          String?               // links to Riqle account if student is registered

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  confirmedAt DateTime?
  cancelledAt DateTime?
  completedAt DateTime?

  User User? @relation(fields: [userId], references: [id])

  @@index([status])
  @@index([scheduledAt])
  @@index([studentEmail])
  @@index([userId])
}

enum TutoringBookingStatus {
  pending
  confirmed
  completed
  cancelled
  no_show
}

enum MeetingFormat {
  in_person
  online
}
